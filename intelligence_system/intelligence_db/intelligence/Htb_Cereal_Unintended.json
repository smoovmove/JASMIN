{
  "writeup_id": "Htb_Cereal_Unintended",
  "scenario_fingerprint": {
    "scenario_name": "windows_iis_shadow_copy_timing_attack",
    "primary_services": [
      "http",
      "iis",
      "ssh"
    ],
    "port_signature": "22+80+443+8080",
    "service_combination": "iis+ssh+internal_web",
    "os_family": "windows_server",
    "environment_type": "iis_web_server",
    "entry_vector": "webshell_privilege_escalation",
    "privilege_path": "webshell_to_root_via_timing",
    "attack_complexity": "hard",
    "estimated_time": "2-3 hours",
    "scenario_confidence": 0.85,
    "distinguishing_factors": [
      "webshell_additional_groups",
      "iis_users_group_membership",
      "shadow_copy_folder_access",
      "asp_net_compilation_timing"
    ],
    "environmental_clues": [
      "temporary_aspnet_files_directory",
      "csc_compiler_errors",
      "iis_staging_directories",
      "webshell_vs_ssh_group_differences"
    ],
    "similar_scenarios": [
      "iis_privilege_escalation",
      "asp_net_timing_attacks"
    ],
    "unique_aspects": [
      "shadow_copy_folder_exploitation",
      "compilation_timing_race_condition",
      "webshell_group_privileges",
      "iis_file_staging_manipulation"
    ]
  },
  "success_patterns": {
    "success_factors": [
      {
        "technique": "IIS_Shadow_Copy_Race_Condition",
        "success_reason": "Timing window between IIS copying source files and compilation allows file modification",
        "prerequisite_indicators": [
          "webshell_has_iis_users_group",
          "asp_net_compilation_errors_visible",
          "temporary_asp_net_files_accessible",
          "iis_service_running_as_privileged_user"
        ],
        "recognition_patterns": [
          "webshell groups differ from SSH groups",
          "IIS_USERS group membership in webshell",
          "ASP.NET compilation error pages with file paths",
          "Temporary ASP.NET Files directory writable"
        ],
        "failure_modes": [
          "no_iis_users_group_membership",
          "compilation_too_fast_for_race",
          "temporary_files_not_accessible",
          "iis_not_running_privileged"
        ],
        "environmental_factors": [
          "iis_shadow_copy_enabled",
          "asp_net_dynamic_compilation",
          "privileged_iis_worker_process",
          "writable_temp_directories"
        ],
        "success_probability": 0.65,
        "typical_timeframe": "30-60 seconds per attempt"
      },
      {
        "technique": "Group_Membership_Enumeration",
        "success_reason": "Webshell process token has additional IIS-related groups not visible in SSH",
        "prerequisite_indicators": [
          "multiple_access_methods_available",
          "iis_hosting_application",
          "different_process_contexts"
        ],
        "recognition_patterns": [
          "whoami /groups shows different results",
          "IIS_USERS group in webshell only",
          "additional service groups in web context"
        ],
        "failure_modes": [
          "same_groups_across_contexts",
          "no_iis_integration",
          "restricted_group_enumeration"
        ],
        "environmental_factors": [
          "iis_token_impersonation",
          "service_account_integration",
          "windows_group_inheritance"
        ],
        "success_probability": 0.95,
        "typical_timeframe": "2-5 minutes"
      }
    ],
    "critical_discoveries": [
      {
        "discovery": "IIS_USERS group membership in webshell",
        "discovery_method": "whoami /groups comparison between SSH and webshell",
        "why_critical": "Enables access to IIS temporary compilation directories for race condition",
        "how_to_recognize": [
          "different group memberships across access methods",
          "IIS_USERS or similar service groups",
          "web application running as privileged user"
        ],
        "follow_up_actions": [
          "enumerate_temporary_asp_net_files",
          "test_write_permissions_temp_dirs",
          "identify_compilation_timing_windows"
        ]
      },
      {
        "discovery": "ASP.NET compilation error with file paths",
        "discovery_method": "Accessing misconfigured web application",
        "why_critical": "Reveals Shadow Copy Folders path and compilation process details",
        "how_to_recognize": [
          "detailed compiler output visible",
          "temporary asp.net files paths exposed",
          "csc.exe command line parameters shown"
        ],
        "follow_up_actions": [
          "navigate_to_temp_directories",
          "analyze_compilation_timing",
          "prepare_malicious_source_files"
        ]
      }
    ],
    "escalation_keys": [
      {
        "privilege_level": "iis_users_group",
        "escalation_method": "Shadow_Copy_Race_Condition",
        "why_possible": "IIS copies source files before compilation with timing window for modification",
        "recognition_signs": [
          "writable_temporary_asp_net_files",
          "compilation_process_observable",
          "iis_running_as_system_or_admin"
        ],
        "exploitation_path": "Delete temp files → Trigger recompilation → Modify source during copy → Execute as IIS user"
      }
    ]
  },
  "decision_tree": {
    "decision_points": [
      {
        "step": 1,
        "situation": "Found webshell access as user sonny on Windows IIS server",
        "decision": "Compare webshell groups vs SSH groups for privilege differences",
        "reasoning": "IIS processes often have additional groups that SSH sessions lack",
        "confidence": 0.9,
        "alternatives": [
          {
            "option": "direct_privilege_escalation",
            "when": "if no group differences found"
          },
          {
            "option": "service_enumeration",
            "when": "if IIS not confirmed"
          }
        ],
        "success_indicators": [
          "IIS_USERS_group_present_in_webshell",
          "additional_domain_groups_found",
          "different_token_privileges"
        ],
        "next_decision": "enumerate_iis_specific_attack_vectors"
      },
      {
        "step": 2,
        "situation": "Confirmed IIS_USERS group membership in webshell context",
        "decision": "Investigate ASP.NET Temporary Files directory for timing attack",
        "reasoning": "IIS_USERS often has write access to compilation staging areas",
        "confidence": 0.85,
        "prerequisites": [
          "webshell_access",
          "IIS_USERS_membership",
          "aspnet_site_identified"
        ],
        "success_indicators": [
          "temporary_aspnet_files_accessible",
          "compilation_artifacts_found",
          "source_files_in_staging_area"
        ],
        "failure_fallbacks": [
          "web_config_modification",
          "iis_logs_analysis",
          "application_pool_enumeration"
        ]
      },
      {
        "step": 3,
        "situation": "Found ASP.NET compilation staging directory with source files",
        "decision": "Execute timing attack on IIS compilation process",
        "reasoning": "Window exists between source copy and compilation where files can be modified",
        "confidence": 0.75,
        "prerequisites": [
          "write_access_to_temp_files",
          "ability_to_trigger_recompilation"
        ],
        "success_indicators": [
          "source_files_successfully_modified",
          "malicious_code_compiled",
          "elevated_execution_achieved"
        ],
        "failure_fallbacks": [
          "dll_hijacking",
          "config_file_modification"
        ]
      }
    ],
    "branching_logic": {
      "if_iis_users_group_found": {
        "action": "enumerate_iis_attack_surface",
        "tools": [
          "dir",
          "icacls",
          "whoami /groups"
        ],
        "next_phase": "temporary_files_investigation"
      },
      "if_temp_files_writable": {
        "action": "setup_timing_attack",
        "steps": [
          "clear_compilation_cache",
          "trigger_recompilation",
          "inject_malicious_code_during_window"
        ],
        "tools": [
          "custom_timing_script",
          "file_monitoring"
        ]
      },
      "if_timing_attack_succeeds": {
        "action": "execute_as_application_pool_identity",
        "purpose": "achieve_privilege_escalation",
        "expected_privileges": "system_or_service_account"
      }
    },
    "optimization_rules": [
      {
        "rule": "always_compare_webshell_vs_ssh_groups",
        "reasoning": "different_execution_contexts_have_different_privileges",
        "applicability": "windows_iis_environments"
      },
      {
        "rule": "investigate_temporary_aspnet_files_with_iis_users",
        "reasoning": "common_privilege_escalation_vector_via_compilation_race",
        "applicability": "aspnet_applications_with_iis_users_access"
      },
      {
        "rule": "use_timing_attacks_on_compilation_processes",
        "reasoning": "brief_window_exists_between_copy_and_compile_operations",
        "applicability": "writable_access_to_compilation_staging_areas"
      }
    ]
  },
  "applicability_rules": {
    "technique_rules": [
      {
        "technique": "IIS Shadow Copy Timing Attack",
        "mitre_id": "T1055.012",
        "required_services": [
          "iis",
          "http",
          "https"
        ],
        "required_ports": [
          80,
          443,
          8080,
          8443
        ],
        "os_requirements": [
          "windows"
        ],
        "environmental_prerequisites": [
          "iis_webserver_running",
          "asp_net_application_present",
          "write_access_to_temp_aspnet_files",
          "iis_users_group_membership",
          "dynamic_compilation_enabled"
        ],
        "success_indicators": [
          "temporary_aspnet_files_accessible",
          "compilation_errors_visible",
          "shadow_copy_folders_present",
          "webshell_has_iis_groups"
        ],
        "incompatible_with": [
          "precompiled_applications",
          "temp_files_access_denied",
          "compilation_disabled",
          "insufficient_privileges"
        ],
        "confidence_boosters": [
          "detailed_compiler_output_enabled",
          "csc_exe_compilation_visible",
          "app_web_dll_files_present",
          "multiple_shadow_copy_directories"
        ],
        "typical_success_rate": 0.65,
        "estimated_time": "15-30 minutes"
      },
      {
        "technique": "IIS Group Privilege Escalation",
        "mitre_id": "T1134.001",
        "required_services": [
          "iis"
        ],
        "required_ports": [
          80,
          443,
          8080
        ],
        "os_requirements": [
          "windows"
        ],
        "environmental_prerequisites": [
          "webshell_execution_context",
          "iis_users_group_membership",
          "different_privileges_webshell_vs_ssh",
          "asp_net_application_running"
        ],
        "success_indicators": [
          "additional_groups_in_webshell",
          "iis_users_group_present",
          "source_domain_group_membership",
          "elevated_file_system_access"
        ],
        "incompatible_with": [
          "identical_ssh_webshell_privileges",
          "restricted_iis_configuration",
          "application_pool_isolation"
        ],
        "confidence_boosters": [
          "whoami_groups_difference",
          "webserver_running_as_user",
          "asp_net_framework_present"
        ],
        "typical_success_rate": 0.78,
        "estimated_time": "10-20 minutes"
      },
      {
        "technique": "ASP.NET Compilation Directory Manipulation",
        "mitre_id": "T1574.012",
        "required_services": [
          "iis",
          "asp.net"
        ],
        "required_ports": [
          80,
          443,
          8080,
          8443
        ],
        "os_requirements": [
          "windows"
        ],
        "environmental_prerequisites": [
          "asp_net_dynamic_compilation",
          "temporary_files_write_access",
          "compilation_timing_window",
          "source_code_modification_capability"
        ],
        "success_indicators": [
          "app_web_cs_files_visible",
          "compilation_command_exposed",
          "shadow_copy_directory_writable",
          "timing_attack_window_exists"
        ],
        "incompatible_with": [
          "precompiled_binaries_only",
          "read_only_temp_directories",
          "immediate_compilation",
          "source_protection_enabled"
        ],
        "confidence_boosters": [
          "csc_exe_command_line_visible",
          "multiple_cs_source_files",
          "compilation_error_messages",
          "framework64_path_accessible"
        ],
        "typical_success_rate": 0.55,
        "estimated_time": "20-45 minutes"
      }
    ],
    "environmental_detectors": {
      "iis_webserver": {
        "port_indicators": [
          80,
          443,
          8080,
          8443
        ],
        "service_indicators": [
          "iis",
          "http",
          "https"
        ],
        "banner_indicators": [
          "Microsoft-IIS",
          "ASP.NET",
          "Server: Microsoft-IIS"
        ],
        "confidence_threshold": 0.85
      },
      "asp_net_application": {
        "port_indicators": [
          80,
          443,
          8080,
          8443
        ],
        "service_indicators": [
          "http",
          "https"
        ],
        "technology_indicators": [
          "asp.net",
          "aspx",
          "temporary asp.net files"
        ],
        "confidence_threshold": 0.9
      },
      "windows_iis_environment": {
        "port_indicators": [
          80,
          443,
          135,
          445
        ],
        "service_indicators": [
          "iis",
          "smb",
          "rpc"
        ],
        "banner_indicators": [
          "Windows Server",
          "Microsoft-IIS",
          "ASP.NET"
        ],
        "confidence_threshold": 0.88
      }
    },
    "attack_prioritization": {
      "high_priority": [
        {
          "attack": "iis_group_privilege_check",
          "when": "webshell_access_and_iis_detected",
          "reason": "often_reveals_additional_privileges_in_webshell_context"
        },
        {
          "attack": "temporary_aspnet_files_enumeration",
          "when": "asp_net_application_detected",
          "reason": "reveals_compilation_process_and_timing_opportunities"
        }
      ],
      "medium_priority": [
        {
          "attack": "shadow_copy_timing_attack",
          "when": "temp_files_writable_and_compilation_visible",
          "reason": "complex_but_high_impact_code_execution"
        },
        {
          "attack": "compilation_error_information_gathering",
          "when": "asp_net_errors_visible",
          "reason": "reveals_internal_paths_and_compilation_details"
        }
      ]
    }
  },
  "technique_intelligence": {
    "techniques": [
      {
        "name": "IIS Shadow Copy Timing Attack",
        "mitre_id": "T1055.012",
        "category": "privilege_escalation",
        "phase": "privilege_escalation",
        "tools_used": [
          {
            "name": "webshell",
            "command_template": "del * && {trigger_compilation}",
            "actual_command": "del * from C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\Temporary ASP.NET Files\\root\\{hash}\\{hash}\\",
            "output_pattern": "Directory cleared, files regenerated on next request",
            "effectiveness_rating": 4,
            "reliability": 0.75
          },
          {
            "name": "iwr",
            "command_template": "iwr http://127.0.0.1:{port} -UseBasicParsing",
            "actual_command": "iwr http://127.0.0.1:8080 -UseBasicParsing",
            "success_factors": [
              "timing_window_available",
              "write_permissions_to_shadow_copy"
            ],
            "effectiveness_rating": 3
          }
        ],
        "prerequisites": [
          "webshell_access_as_iis_user",
          "iis_users_group_membership",
          "asp_net_application_running_as_privileged_user",
          "write_access_to_temporary_aspnet_files"
        ],
        "success_indicators": [
          "shadow_copy_directory_cleared_successfully",
          "source_files_regenerated_on_request",
          "timing_window_exploitable_between_copy_and_compile",
          "modified_source_compiled_and_executed"
        ],
        "common_failures": [
          "insufficient_timing_window",
          "lack_of_iis_users_group_membership",
          "application_not_running_as_privileged_user",
          "compilation_errors_in_modified_source"
        ],
        "follow_up_techniques": [
          "code_injection_in_cs_files",
          "reverse_shell_execution",
          "privilege_escalation_to_system"
        ],
        "time_investment": "30-60 minutes",
        "skill_level": "advanced"
      },
      {
        "name": "IIS Group Privilege Abuse",
        "mitre_id": "T1134.001",
        "category": "privilege_escalation",
        "phase": "privilege_escalation",
        "tools_used": [
          {
            "name": "whoami",
            "command_template": "whoami /groups",
            "actual_command": "whoami /groups",
            "output_pattern": "IIS_USERS group membership visible in webshell context",
            "effectiveness_rating": 5,
            "reliability": 1.0
          }
        ],
        "prerequisites": [
          "webshell_execution_context",
          "iis_managed_application",
          "different_token_privileges_webshell_vs_ssh"
        ],
        "success_indicators": [
          "iis_users_group_visible_in_webshell",
          "additional_groups_not_present_in_ssh_session",
          "elevated_file_system_permissions"
        ],
        "common_failures": [
          "same_privileges_across_execution_contexts",
          "insufficient_group_permissions"
        ],
        "follow_up_techniques": [
          "shadow_copy_manipulation",
          "iis_configuration_abuse"
        ],
        "time_investment": "5-10 minutes",
        "skill_level": "intermediate"
      }
    ],
    "tool_effectiveness": [
      {
        "tool": "webshell",
        "use_case": "iis_shadow_copy_manipulation",
        "effectiveness_rating": 4,
        "reliability": 0.8,
        "learning_curve": "medium",
        "essential_for": [
          "iis_privilege_escalation"
        ],
        "alternatives": [
          "direct_file_system_access",
          "powershell_remoting"
        ],
        "best_practices": [
          "verify_iis_users_group_membership_first",
          "identify_shadow_copy_directory_structure",
          "practice_timing_attack_multiple_times",
          "prepare_malicious_cs_code_in_advance"
        ]
      },
      {
        "tool": "ASP.NET_Temporary_Files",
        "use_case": "code_injection_via_compilation_race",
        "effectiveness_rating": 3,
        "reliability": 0.7,
        "learning_curve": "high",
        "essential_for": [
          "asp_net_privilege_escalation"
        ],
        "alternatives": [
          "direct_dll_replacement",
          "web_config_modification"
        ],
        "best_practices": [
          "understand_compilation_process_timing",
          "monitor_file_creation_timestamps",
          "prepare_valid_cs_syntax_modifications",
          "test_on_similar_environment_first"
        ]
      }
    ],
    "command_sequences": [
      {
        "sequence_name": "iis_shadow_copy_timing_attack",
        "steps": [
          {
            "step": 1,
            "command": "whoami /groups",
            "purpose": "Verify IIS_USERS group membership in webshell context",
            "expected_output": "IIS_USERS group present"
          },
          {
            "step": 2,
            "command": "cd C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\Temporary ASP.NET Files\\root",
            "purpose": "Navigate to shadow copy root directory",
            "expected_output": "Directory change successful"
          },
          {
            "step": 3,
            "command": "dir",
            "purpose": "Identify active application hash directories",
            "expected_output": "Hash-named subdirectories visible"
          },
          {
            "step": 4,
            "command": "cd {hash_dir1}\\{hash_dir2}",
            "purpose": "Enter specific application shadow copy directory",
            "expected_output": "Access to compilation staging area"
          },
          {
            "step": 5,
            "command": "del *",
            "purpose": "Clear all compiled files to force recompilation",
            "expected_output": "Files deleted successfully"
          },
          {
            "step": 6,
            "command": "iwr http://127.0.0.1:8080 -UseBasicParsing",
            "purpose": "Trigger application recompilation process",
            "expected_output": "Compilation process initiated, timing window available"
          }
        ],
        "success_rate": 0.65,
        "typical_duration": "45-90 minutes"
      }
    ]
  },
  "metadata": {
    "basic_metadata": {
      "name": "Cereal",
      "difficulty": "Hard",
      "os": "Windows Server 2019",
      "platform": "HackTheBox",
      "release_date": "2021-02-27",
      "author": "egre55",
      "estimated_time": "4-6 hours"
    },
    "intelligence_metadata": {
      "attack_complexity": "high",
      "skill_level_required": "advanced",
      "primary_attack_vectors": [
        "web_exploitation",
        "timing_attack",
        "iis_exploitation"
      ],
      "key_vulnerabilities": [
        "race_condition",
        "iis_compilation_timing",
        "privilege_escalation"
      ],
      "environment_type": "web_server_iis",
      "real_world_relevance": "medium",
      "learning_value": [
        "timing_attacks",
        "iis_internals",
        "shadow_copy_exploitation",
        "race_conditions"
      ],
      "prerequisite_knowledge": [
        "web_exploitation",
        "windows_internals",
        "iis_architecture",
        "timing_attacks"
      ]
    },
    "categorization": {
      "primary_category": "web_exploitation",
      "subcategories": [
        "timing_attack",
        "race_condition",
        "iis_exploitation"
      ],
      "attack_types": [
        "privilege_escalation",
        "code_injection",
        "timing_attack"
      ],
      "defensive_lessons": [
        "secure_compilation_process",
        "proper_file_permissions",
        "iis_hardening"
      ]
    },
    "similarity_markers": {
      "similar_boxes": [
        "Conceal",
        "JSON",
        "Worker"
      ],
      "similarity_reasons": [
        "web_exploitation",
        "windows_server",
        "complex_privilege_escalation"
      ],
      "unique_aspects": [
        "shadow_copy_timing_attack",
        "iis_compilation_race",
        "webshell_vs_ssh_groups"
      ],
      "difficulty_factors": [
        "timing_precision_required",
        "deep_iis_knowledge",
        "race_condition_exploitation"
      ]
    }
  },
  "extraction_metadata": {
    "parse_date": "2025-07-04T12:08:31.205113",
    "original_file": "0xdf_writeups/Htb Cereal Unintended.md",
    "content_length": 21048,
    "extraction_version": "2.0-claude",
    "model_used": "claude-sonnet-4-20250514"
  },
  "intelligence_confidence": 0.9166666666666667,
  "quality_breakdown": {
    "scenario_uniqueness": 1.0,
    "success_logic_clarity": 0.6666666666666666,
    "applicability_completeness": 1.0,
    "decision_tree_depth": 1.0,
    "technique_actionability": 1.0
  }
}