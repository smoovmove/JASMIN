{
  "writeup_id": "Htb_Pivotapi_More",
  "scenario_fingerprint": {
    "scenario_name": "windows_mssql_service_privilege_escalation",
    "primary_services": [
      "mssql",
      "rpc",
      "smb"
    ],
    "port_signature": "1433+135+445",
    "service_combination": "mssql+rpc+smb",
    "os_family": "windows_server",
    "environment_type": "standalone_server",
    "entry_vector": "mssql_service_account",
    "privilege_path": "service_account_to_system",
    "attack_complexity": "easy",
    "estimated_time": "30-45 minutes",
    "scenario_confidence": 0.92,
    "distinguishing_factors": [
      "mssql_service_account_privileges",
      "seimpersonate_privilege",
      "semanagevolume_privilege",
      "blocked_outbound_connections"
    ],
    "environmental_clues": [
      "nt_service_mssql_account",
      "multiple_privilege_escalation_paths",
      "disabled_print_spooler",
      "restricted_network_egress"
    ],
    "similar_scenarios": [
      "sql_server_service_accounts",
      "windows_service_privilege_abuse"
    ],
    "unique_aspects": [
      "efspotato_exploitation",
      "semanagevolume_disk_access",
      "multiple_privilege_vectors",
      "network_restrictions_bypass"
    ]
  },
  "success_patterns": {
    "success_factors": [
      {
        "technique": "EfsPotato",
        "success_reason": "SeImpersonatePrivilege enabled on MSSQL service account with MS-EFS RPC API available",
        "prerequisite_indicators": [
          "seimpersonate_privilege_enabled",
          "ms_efs_service_running",
          "local_rpc_accessible",
          "print_spooler_disabled"
        ],
        "recognition_patterns": [
          "service account with SeImpersonatePrivilege",
          "outbound TCP 135 blocked (RoguePotato fails)",
          "print spooler disabled (PrintSpoofer fails)",
          "MS-EFS RPC API responds"
        ],
        "failure_modes": [
          "seimpersonate_privilege_disabled",
          "ms_efs_service_unavailable",
          "rpc_endpoints_blocked",
          "insufficient_privileges"
        ],
        "environmental_factors": [
          "default_mssql_service_configuration",
          "windows_efs_enabled",
          "restrictive_outbound_firewall",
          "hardened_print_spooler"
        ],
        "success_probability": 0.85,
        "typical_timeframe": "10-20 minutes"
      },
      {
        "technique": "SeManageVolumePrivilege_Abuse",
        "success_reason": "MSSQL service had SeManageVolumePrivilege allowing disk-level access",
        "prerequisite_indicators": [
          "semanagevolume_privilege_enabled",
          "ntfs_filesystem",
          "write_access_to_temp_directory",
          "compiled_exploit_available"
        ],
        "recognition_patterns": [
          "SeManageVolumePrivilege in whoami /priv",
          "service running with disk maintenance rights",
          "FSCTL_SD_GLOBAL_CHANGE API available",
          "ability to re-ACL entire drive"
        ],
        "failure_modes": [
          "privilege_not_enabled",
          "non_ntfs_filesystem",
          "api_calls_blocked",
          "compilation_issues"
        ],
        "environmental_factors": [
          "default_mssql_privilege_assignment",
          "windows_ntfs_security_model",
          "unrestricted_api_access",
          "standard_windows_acl_structure"
        ],
        "success_probability": 0.78,
        "typical_timeframe": "15-30 minutes"
      },
      {
        "technique": "Delegation_DCSync",
        "success_reason": "Service account had delegation rights allowing DCSync attack",
        "prerequisite_indicators": [
          "domain_joined_machine",
          "service_account_with_delegation",
          "domain_controller_accessible",
          "kerberos_authentication_working"
        ],
        "recognition_patterns": [
          "service account in domain environment",
          "delegation permissions configured",
          "bloodhound shows delegation paths",
          "DCSync rights available"
        ],
        "failure_modes": [
          "no_delegation_configured",
          "constrained_delegation_only",
          "dc_not_accessible",
          "kerberos_blocked"
        ],
        "environmental_factors": [
          "active_directory_domain",
          "service_delegation_configured",
          "insufficient_delegation_hardening",
          "default_ad_permissions"
        ],
        "success_probability": 0.72,
        "typical_timeframe": "20-40 minutes"
      }
    ],
    "critical_discoveries": [
      {
        "discovery": "MSSQL service account privileges",
        "discovery_method": "whoami /priv enumeration",
        "why_critical": "Multiple privilege escalation paths available",
        "how_to_recognize": [
          "SeImpersonatePrivilege enabled",
          "SeManageVolumePrivilege enabled",
          "service account context",
          "multiple escalation options"
        ],
        "follow_up_actions": [
          "test_efspotato_exploit",
          "compile_semanagevolume_abuse",
          "check_delegation_rights",
          "enumerate_available_apis"
        ]
      },
      {
        "discovery": "Blocked outbound connections",
        "discovery_method": "Failed RoguePotato attempts",
        "why_critical": "Eliminates common privilege escalation methods",
        "how_to_recognize": [
          "TCP 135 outbound blocked",
          "RoguePotato connection failures",
          "restrictive firewall rules",
          "need for alternative techniques"
        ],
        "follow_up_actions": [
          "try_efspotato_alternative",
          "test_local_rpc_endpoints",
          "enumerate_available_services",
          "check_alternative_potato_variants"
        ]
      }
    ],
    "escalation_keys": [
      {
        "privilege_level": "mssql_service_account",
        "escalation_method": "SeImpersonatePrivilege_via_EfsPotato",
        "why_possible": "MS-EFS RPC API solicits SYSTEM authentication locally",
        "recognition_signs": [
          "seimpersonate_privilege_enabled",
          "ms_efs_service_running",
          "local_rpc_accessible",
          "token_impersonation_possible"
        ],
        "exploitation_path": "EfsPotato → SYSTEM token → Full admin access"
      },
      {
        "privilege_level": "mssql_service_account",
        "escalation_method": "SeManageVolumePrivilege_Drive_ReACL",
        "why_possible": "Privilege allows disk-level access and ACL modification",
        "recognition_signs": [
          "semanagevolume_privilege_enabled",
          "fsctl_sd_global_change_available",
          "ntfs_filesystem_present",
          "drive_handle_accessible"
        ],
        "exploitation_path": "Drive handle → FSCTL_SD_GLOBAL_CHANGE → Re-ACL entire drive → Full file access"
      },
      {
        "privilege_level": "domain_service_account",
        "escalation_method": "Delegation_to_DCSync",
        "why_possible": "Service account configured with delegation rights",
        "recognition_signs": [
          "domain_joined_service",
          "delegation_configured",
          "dcsync_rights_available",
          "kerberos_delegation_possible"
        ],
        "exploitation_path": "Service delegation → DCSync attack → Domain admin hashes"
      }
    ]
  },
  "decision_tree": {
    "decision_points": [
      {
        "step": 1,
        "situation": "MSSQL service account access with SeImpersonatePrivilege",
        "decision": "Check for outbound connectivity before choosing impersonation exploit",
        "reasoning": "RoguePotato requires outbound TCP 135, but EfsPotato works without network access",
        "confidence": 0.9,
        "alternatives": [
          {
            "option": "efspotato",
            "when": "if outbound blocked"
          },
          {
            "option": "roguepotato",
            "when": "if outbound allowed"
          },
          {
            "option": "printspoofer",
            "when": "if print spooler enabled"
          }
        ],
        "success_indicators": [
          "system_token_obtained",
          "nt_authority_system_access"
        ],
        "next_decision": "execute_system_commands"
      },
      {
        "step": 2,
        "situation": "Service account has SeManageVolumePrivilege enabled",
        "decision": "Use SeManageVolumeAbuse to re-ACL entire drive",
        "reasoning": "Direct disk access allows changing permissions from administrators to users group",
        "confidence": 0.85,
        "prerequisites": [
          "SeManageVolumePrivilege_enabled",
          "compiled_exploit_available"
        ],
        "success_indicators": [
          "can_read_admin_files",
          "permissions_changed_message"
        ],
        "failure_fallbacks": [
          "try_seimpersonate_methods"
        ]
      },
      {
        "step": 3,
        "situation": "MSSQL service on Domain Controller with network authentication",
        "decision": "Attempt DCSync via delegation abuse",
        "reasoning": "Service accounts authenticate as machine account, DC machine account can DCSync",
        "confidence": 0.8,
        "prerequisites": [
          "domain_controller_identified",
          "service_account_access",
          "rubeus_available"
        ],
        "success_indicators": [
          "delegation_ticket_obtained",
          "dcsync_successful"
        ],
        "failure_fallbacks": [
          "local_privilege_escalation_methods"
        ]
      }
    ],
    "branching_logic": {
      "if_seimpersonate_available": {
        "action": "check_network_connectivity",
        "tools": [
          "efspotato",
          "roguepotato",
          "printspoofer"
        ],
        "decision_criteria": "based_on_outbound_access_and_services"
      },
      "if_semanagevolume_available": {
        "action": "compile_and_run_volume_abuse",
        "tools": [
          "visual_studio",
          "semanagevolume_exploit"
        ],
        "next_phase": "full_filesystem_access"
      },
      "if_domain_controller_service": {
        "action": "attempt_delegation_dcsync",
        "tools": [
          "rubeus",
          "mimikatz"
        ],
        "purpose": "extract_all_domain_credentials"
      }
    },
    "optimization_rules": [
      {
        "rule": "prioritize_efspotato_over_roguepotato_in_restricted_networks",
        "reasoning": "efspotato_works_without_outbound_connectivity",
        "applicability": "seimpersonate_privilege_available"
      },
      {
        "rule": "check_multiple_privileges_simultaneously",
        "reasoning": "service_accounts_often_have_multiple_dangerous_privileges",
        "applicability": "service_account_access_obtained"
      },
      {
        "rule": "attempt_dcsync_when_service_runs_on_dc",
        "reasoning": "machine_account_delegation_provides_dc_level_access",
        "applicability": "domain_controller_service_account"
      }
    ]
  },
  "applicability_rules": {
    "technique_rules": [
      {
        "technique": "EfsPotato",
        "mitre_id": "T1134.001",
        "required_services": [
          "mssql"
        ],
        "required_ports": [
          1433,
          1434
        ],
        "os_requirements": [
          "windows"
        ],
        "environmental_prerequisites": [
          "SeImpersonatePrivilege_enabled",
          "ms_efs_service_available",
          "local_rpc_accessible"
        ],
        "success_indicators": [
          "SeImpersonatePrivilege_present",
          "efs_service_running",
          "system_token_acquired"
        ],
        "incompatible_with": [
          "efs_service_disabled",
          "rpc_blocked",
          "privilege_removed"
        ],
        "confidence_boosters": [
          "mssql_service_account",
          "default_windows_configuration",
          "print_spooler_disabled"
        ],
        "typical_success_rate": 0.85,
        "estimated_time": "2-5 minutes"
      },
      {
        "technique": "SeManageVolumePrivilege",
        "mitre_id": "T1134.001",
        "required_services": [],
        "required_ports": [],
        "os_requirements": [
          "windows"
        ],
        "environmental_prerequisites": [
          "SeManageVolumePrivilege_enabled",
          "disk_access_available",
          "ntfs_filesystem"
        ],
        "success_indicators": [
          "SeManageVolumePrivilege_present",
          "disk_handle_created",
          "file_system_control_access"
        ],
        "incompatible_with": [
          "privilege_removed",
          "disk_encryption_blocking",
          "access_control_hardened"
        ],
        "confidence_boosters": [
          "service_account_context",
          "default_privilege_assignment",
          "ntfs_permissions"
        ],
        "typical_success_rate": 0.9,
        "estimated_time": "1-3 minutes"
      },
      {
        "technique": "DCSync",
        "mitre_id": "T1003.006",
        "required_services": [
          "kerberos",
          "ldap"
        ],
        "required_ports": [
          88,
          389,
          445
        ],
        "os_requirements": [
          "windows"
        ],
        "environmental_prerequisites": [
          "active_directory_domain",
          "delegation_rights_present",
          "domain_controller_accessible"
        ],
        "success_indicators": [
          "delegation_permissions_confirmed",
          "dc_replication_rights",
          "krbtgt_hash_extracted"
        ],
        "incompatible_with": [
          "delegation_disabled",
          "replication_blocked",
          "network_isolation"
        ],
        "confidence_boosters": [
          "service_account_delegation",
          "default_ad_permissions",
          "domain_admin_equivalent"
        ],
        "typical_success_rate": 0.95,
        "estimated_time": "3-10 minutes"
      }
    ],
    "environmental_detectors": {
      "mssql_service": {
        "port_indicators": [
          1433,
          1434
        ],
        "service_indicators": [
          "mssql",
          "sqlserver"
        ],
        "banner_indicators": [
          "Microsoft SQL Server",
          "MSSQL"
        ],
        "confidence_threshold": 0.9
      },
      "active_directory": {
        "port_indicators": [
          53,
          88,
          389,
          445,
          3268
        ],
        "service_indicators": [
          "kerberos",
          "ldap",
          "smb",
          "dns"
        ],
        "banner_indicators": [
          "Active Directory",
          "Windows Server"
        ],
        "confidence_threshold": 0.85
      },
      "windows_privileges": {
        "port_indicators": [],
        "service_indicators": [
          "rpc",
          "efs"
        ],
        "banner_indicators": [
          "Windows",
          "NT Service"
        ],
        "confidence_threshold": 0.8
      }
    },
    "attack_prioritization": {
      "high_priority": [
        {
          "attack": "efspotato",
          "when": "SeImpersonatePrivilege_detected",
          "reason": "reliable_system_escalation_no_outbound_required"
        },
        {
          "attack": "dcsync",
          "when": "delegation_rights_detected",
          "reason": "domain_admin_equivalent_access"
        }
      ],
      "medium_priority": [
        {
          "attack": "semanagevolume_abuse",
          "when": "SeManageVolumePrivilege_detected",
          "reason": "direct_disk_access_full_admin"
        }
      ]
    }
  },
  "technique_intelligence": {
    "techniques": [
      {
        "name": "SeImpersonatePrivilege Abuse via EfsPotato",
        "mitre_id": "T1134.001",
        "category": "privilege_escalation",
        "phase": "privilege_escalation",
        "tools_used": [
          {
            "name": "EfsPotato",
            "command_template": ".\\efspotato.exe {command}",
            "actual_command": ".\\efs.exe whoami",
            "output_pattern": "nt authority\\system",
            "effectiveness_rating": 5,
            "reliability": 0.95,
            "compile_command": "C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe efspotato.cs"
          }
        ],
        "prerequisites": [
          "SeImpersonatePrivilege_enabled",
          "ms_efs_rpc_api_accessible",
          "outbound_tcp_135_blocked"
        ],
        "success_indicators": [
          "system_token_acquired",
          "command_execution_as_system",
          "privilege_escalation_confirmed"
        ],
        "common_failures": [
          "missing_seimpersonate_privilege",
          "efs_service_unavailable",
          "compilation_errors"
        ],
        "follow_up_techniques": [
          "credential_dumping",
          "persistence_mechanisms",
          "lateral_movement"
        ],
        "time_investment": "5-15 minutes",
        "skill_level": "intermediate"
      },
      {
        "name": "SeManageVolumePrivilege Abuse",
        "mitre_id": "T1134.001",
        "category": "privilege_escalation",
        "phase": "privilege_escalation",
        "tools_used": [
          {
            "name": "SeManageVolumeAbuse",
            "command_template": ".\\{binary_name}",
            "actual_command": ".\\v",
            "output_pattern": "Success! Permissions changed.",
            "effectiveness_rating": 5,
            "reliability": 0.98,
            "github_source": "https://github.com/xct/SeManageVolumeAbuse"
          }
        ],
        "prerequisites": [
          "SeManageVolumePrivilege_enabled",
          "access_to_drive_handle",
          "compiled_exploit_binary"
        ],
        "success_indicators": [
          "drive_permissions_changed",
          "admin_files_accessible",
          "full_filesystem_read_write"
        ],
        "common_failures": [
          "missing_privilege",
          "compilation_issues",
          "drive_access_denied"
        ],
        "follow_up_techniques": [
          "credential_harvesting",
          "backdoor_installation",
          "data_exfiltration"
        ],
        "time_investment": "10-20 minutes",
        "skill_level": "intermediate"
      },
      {
        "name": "DCSync via Delegation Abuse",
        "mitre_id": "T1003.006",
        "category": "credential_access",
        "phase": "credential_access",
        "tools_used": [
          {
            "name": "Rubeus",
            "command_template": ".\\Rubeus.exe tgtdeleg /nowrap",
            "actual_command": ".\\Rubeus.exe tgtdeleg /nowrap",
            "output_pattern": "base64(ticket.kirbi):",
            "effectiveness_rating": 5,
            "reliability": 0.92,
            "source": "https://github.com/Flangvik/SharpCollection"
          },
          {
            "name": "ticketConverter.py",
            "command_template": "ticketConverter.py {kirbi_file} {ccache_file}",
            "actual_command": "ticketConverter.py machine.kirbi machine.ccache",
            "output_pattern": "[+] done",
            "effectiveness_rating": 5,
            "reliability": 0.99
          }
        ],
        "prerequisites": [
          "service_account_context",
          "domain_controller_access",
          "machine_account_delegation_rights"
        ],
        "success_indicators": [
          "delegation_ticket_acquired",
          "ticket_conversion_successful",
          "dcsync_attack_possible"
        ],
        "common_failures": [
          "insufficient_delegation_rights",
          "network_connectivity_issues",
          "kerberos_authentication_failures"
        ],
        "follow_up_techniques": [
          "secretsdump_execution",
          "golden_ticket_creation",
          "domain_persistence"
        ],
        "time_investment": "15-30 minutes",
        "skill_level": "advanced"
      }
    ],
    "tool_effectiveness": [
      {
        "tool": "EfsPotato",
        "use_case": "seimpersonate_privilege_escalation",
        "effectiveness_rating": 5,
        "reliability": 0.95,
        "learning_curve": "low",
        "essential_for": [
          "windows_service_accounts"
        ],
        "alternatives": [
          "RoguePotato",
          "PrintSpoofer"
        ],
        "best_practices": [
          "compile_with_release_x64_configuration",
          "test_efs_service_availability",
          "use_when_outbound_135_blocked"
        ]
      },
      {
        "tool": "Rubeus",
        "use_case": "kerberos_delegation_abuse",
        "effectiveness_rating": 5,
        "reliability": 0.92,
        "learning_curve": "medium",
        "essential_for": [
          "active_directory_environments"
        ],
        "alternatives": [
          "manual_kerberos_tools"
        ],
        "best_practices": [
          "use_precompiled_binaries_from_sharpcollection",
          "convert_tickets_to_ccache_format",
          "validate_delegation_rights_first"
        ]
      }
    ],
    "command_sequences": [
      {
        "sequence_name": "efspotato_privilege_escalation",
        "steps": [
          {
            "step": 1,
            "command": "C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe efspotato.cs",
            "purpose": "Compile EfsPotato exploit",
            "expected_output": "Compilation successful with warnings"
          },
          {
            "step": 2,
            "command": ".\\efspotato.exe whoami",
            "purpose": "Execute privilege escalation",
            "expected_output": "nt authority\\system"
          }
        ],
        "success_rate": 0.95,
        "typical_duration": "5-15 minutes"
      },
      {
        "sequence_name": "semanagevolume_abuse",
        "steps": [
          {
            "step": 1,
            "command": ".\\SeManageVolumeAbuse.exe",
            "purpose": "Change drive permissions",
            "expected_output": "Success! Permissions changed."
          },
          {
            "step": 2,
            "command": "type C:\\users\\cybervaca\\desktop\\root.txt",
            "purpose": "Verify admin file access",
            "expected_output": "Root flag contents"
          }
        ],
        "success_rate": 0.98,
        "typical_duration": "2-5 minutes"
      },
      {
        "sequence_name": "delegation_dcsync_setup",
        "steps": [
          {
            "step": 1,
            "command": ".\\Rubeus.exe tgtdeleg /nowrap",
            "purpose": "Get delegation ticket",
            "expected_output": "base64 encoded kirbi ticket"
          },
          {
            "step": 2,
            "command": "base64 -d machine.kirbi.b64 > machine.kirbi",
            "purpose": "Decode ticket",
            "expected_output": "Binary kirbi file"
          },
          {
            "step": 3,
            "command": "ticketConverter.py machine.kirbi machine.ccache",
            "purpose": "Convert to ccache format",
            "expected_output": "[+] done"
          }
        ],
        "success_rate": 0.92,
        "typical_duration": "10-20 minutes"
      }
    ]
  },
  "metadata": {
    "basic_metadata": {
      "name": "PivotAPI",
      "difficulty": "Hard",
      "os": "Windows Server 2019",
      "platform": "HackTheBox",
      "release_date": "2021-07-31",
      "author": "0xdf",
      "estimated_time": "4-6 hours"
    },
    "intelligence_metadata": {
      "attack_complexity": "high",
      "skill_level_required": "advanced",
      "primary_attack_vectors": [
        "mssql_injection",
        "privilege_escalation",
        "active_directory"
      ],
      "key_vulnerabilities": [
        "seimpersonate_privilege",
        "semanagevolume_privilege",
        "delegation_abuse"
      ],
      "environment_type": "corporate_domain_controller",
      "real_world_relevance": "very_high",
      "learning_value": [
        "advanced_privilege_escalation",
        "delegation_attacks",
        "service_account_abuse",
        "dcsync_attacks"
      ],
      "prerequisite_knowledge": [
        "advanced_ad_concepts",
        "kerberos_delegation",
        "windows_privileges",
        "mssql_exploitation"
      ]
    },
    "categorization": {
      "primary_category": "active_directory",
      "subcategories": [
        "privilege_escalation",
        "delegation_attacks",
        "service_exploitation"
      ],
      "attack_types": [
        "credential_access",
        "privilege_escalation",
        "persistence",
        "defense_evasion"
      ],
      "defensive_lessons": [
        "service_account_hardening",
        "privilege_auditing",
        "delegation_restrictions",
        "sql_service_isolation"
      ]
    },
    "similarity_markers": {
      "similar_boxes": [
        "Blackfield",
        "Monteverde",
        "Multimaster"
      ],
      "similarity_reasons": [
        "advanced_ad_attacks",
        "service_account_exploitation",
        "delegation_abuse",
        "dcsync_capabilities"
      ],
      "unique_aspects": [
        "efspotato_exploitation",
        "semanagevolume_abuse",
        "mssql_initial_foothold"
      ],
      "difficulty_factors": [
        "multiple_escalation_paths",
        "advanced_ad_concepts",
        "service_privilege_abuse"
      ]
    }
  },
  "extraction_metadata": {
    "parse_date": "2025-07-04T23:40:36.063419",
    "original_file": "0xdf_writeups/Htb Pivotapi More.md",
    "content_length": 19446,
    "extraction_version": "2.0-claude",
    "model_used": "claude-sonnet-4-20250514"
  },
  "intelligence_confidence": 1.0,
  "quality_breakdown": {
    "scenario_uniqueness": 1.0,
    "success_logic_clarity": 1.0,
    "applicability_completeness": 1.0,
    "decision_tree_depth": 1.0,
    "technique_actionability": 1.0
  }
}